# 🏗️ Архитектура проекта Content Ideas Generator Bot

## Общее описание

Проект представляет собой асинхронного Telegram-бота для генерации контент-идей и постов с использованием искусственного интеллекта. Архитектура построена на принципах чистого кода, модульности и расширяемости.

## 🎯 Основные принципы архитектуры

### 1. Модульность
Каждый компонент системы независим и отвечает за одну конкретную задачу.

### 2. Асинхронность
Все операции выполняются асинхронно для обеспечения высокой производительности.

### 3. Отказоустойчивость
Система продолжает работать даже при частичных сбоях отдельных компонентов.

### 4. Логирование
Все действия системы логируются для возможности отладки и мониторинга.

### 5. Конфигурируемость
Все параметры настраиваются через переменные окружения без изменения кода.

## 📁 Структура проекта

```
create_idea/
│
├── docs/                           # 📚 Документация
│   ├── architecture.md             # Архитектура системы
│   ├── business_logic.md           # Бизнес-логика и процессы
│   ├── implementation_plan.md      # План реализации
│   ├── prompts_guide.md            # Руководство по промптам
│   └── user_guide.md               # Руководство пользователя
│
├── logs/                           # 📊 Логи приложения
│   ├── bot.log                     # Основной лог
│   ├── bot.log.1                   # Архивный лог 1
│   └── ...                         # Другие архивные логи
│
├── src/                            # 💻 Исходный код
│   │
│   ├── config/                     # ⚙️ Конфигурация
│   │   ├── __init__.py
│   │   └── settings.py             # Настройки из .env
│   │
│   ├── core/                       # 🔧 Ядро системы
│   │   ├── __init__.py
│   │   ├── logger.py               # Система логирования
│   │   └── exceptions.py           # Кастомные исключения
│   │
│   ├── api/                        # 🌐 API клиенты
│   │   ├── __init__.py
│   │   └── proxyapi_client.py      # Клиент для ProxyAPI
│   │
│   ├── bot/                        # 🤖 Telegram бот
│   │   ├── __init__.py
│   │   ├── handlers/               # Обработчики событий
│   │   │   ├── __init__.py
│   │   │   ├── start.py            # Команда /start
│   │   │   ├── conversation.py     # Основной диалог
│   │   │   └── voice.py            # Голосовые сообщения
│   │   ├── keyboards.py            # Клавиатуры для бота
│   │   ├── states.py               # FSM состояния
│   │   └── utils.py                # Утилиты бота
│   │
│   ├── services/                   # 🎨 Бизнес-логика
│   │   ├── __init__.py
│   │   ├── idea_generator.py       # Генерация идей
│   │   ├── post_generator.py       # Генерация постов
│   │   └── moderation.py           # Модерация поведения
│   │
│   ├── prompts/                    # 💬 Система промптов
│   │   ├── __init__.py
│   │   ├── templates.py            # Шаблоны промптов
│   │   └── builders.py             # Построители промптов
│   │
│   └── main.py                     # 🚀 Точка входа
│
├── .env                            # 🔐 Секреты (не в git)
├── .env.example                    # 📝 Пример конфигурации
├── .gitignore                      # 🚫 Исключения для git
├── requirements.txt                # 📦 Зависимости Python
└── README.md                       # 📖 Основная документация
```

## 🔄 Диаграмма потока данных

```
┌─────────────┐
│  Telegram   │
│   User      │
└──────┬──────┘
       │
       ├─────── Текстовое сообщение
       │        Голосовое сообщение
       │        Команды
       │
       v
┌──────────────────────────────────┐
│      Telegram Bot API            │
│      (aiogram framework)         │
└──────┬───────────────────────────┘
       │
       ├──> FSM (Finite State Machine)
       │     ├─ INITIAL
       │     ├─ COLLECTING_NICHE
       │     ├─ COLLECTING_GOAL
       │     ├─ COLLECTING_FORMAT
       │     ├─ GENERATING_IDEAS
       │     ├─ WAITING_IDEA_CHOICE
       │     ├─ GENERATING_POST
       │     └─ COMPLETED
       │
       v
┌──────────────────────────────────┐
│      Handlers                    │
│  ├─ start.py                     │
│  ├─ conversation.py              │
│  └─ voice.py                     │
└──────┬───────────────────────────┘
       │
       v
┌──────────────────────────────────┐
│      Services                    │
│  ├─ moderation.py                │
│  │   └─ Проверка сообщений       │
│  │                               │
│  ├─ idea_generator.py            │
│  │   ├─ Построение промпта       │
│  │   ├─ Вызов AI API             │
│  │   └─ Парсинг JSON ответа      │
│  │                               │
│  └─ post_generator.py            │
│      ├─ Генерация текста поста   │
│      ├─ Генерация промпта для    │
│      │   изображения             │
│      └─ Генерация изображения    │
└──────┬───────────────────────────┘
       │
       v
┌──────────────────────────────────┐
│      API Client                  │
│      (proxyapi_client.py)        │
│                                  │
│  ├─ chat_completion()            │
│  ├─ generate_image()             │
│  └─ transcribe_audio()           │
└──────┬───────────────────────────┘
       │
       v
┌──────────────────────────────────┐
│      ProxyAPI.ru                 │
│      (OpenAI Compatible API)     │
│                                  │
│  ├─ gpt-4o-mini                  │
│  ├─ dall-e-3                     │
│  └─ whisper-1                    │
└──────────────────────────────────┘
```

## 🔌 Компоненты системы

### 1. 🤖 Telegram Bot Layer (src/bot/)

**Назначение**: Взаимодействие с пользователем через Telegram.

**Компоненты**:
- `handlers/` - обработчики команд и сообщений
- `keyboards.py` - интерфейс кнопок
- `states.py` - определение состояний FSM
- `utils.py` - вспомогательные функции (typing indicator, задержки)

**Технологии**: aiogram 3.x

### 2. 🎨 Services Layer (src/services/)

**Назначение**: Бизнес-логика генерации контента и модерации.

**Компоненты**:
- `idea_generator.py` - генерация 5 идей для контента
- `post_generator.py` - создание готового поста с изображением
- `moderation.py` - контроль поведения пользователя и возврат к теме

**Особенности**:
- Динамическое построение промптов на основе собранных данных
- JSON-структурированные ответы от AI
- Многоэтапная генерация (идея → пост → промпт для изображения → изображение)

### 3. 🌐 API Client Layer (src/api/)

**Назначение**: Взаимодействие с ProxyAPI (OpenAI-совместимый API).

**Методы**:
- `chat_completion()` - генерация текста
- `generate_image()` - создание изображений
- `transcribe_audio()` - транскрибация голоса

**Особенности**:
- Асинхронные запросы через httpx
- Автоматическая обработка ошибок и retry логика
- Поддержка streaming ответов (при необходимости)

### 4. 💬 Prompts System (src/prompts/)

**Назначение**: Управление промптами для AI моделей.

**Компоненты**:
- `templates.py` - базовые шаблоны промптов
- `builders.py` - динамическое построение промптов

**Типы промптов**:
- **Модерационные** - проверка сообщений на соответствие теме
- **Генерационные идей** - создание 5 идей на основе параметров
- **Генерационные постов** - создание полного поста
- **Генерационные изображений** - создание промпта для DALL-E

### 5. ⚙️ Configuration Layer (src/config/)

**Назначение**: Управление настройками приложения.

**Функции**:
- Загрузка переменных из .env
- Валидация конфигурации
- Предоставление типизированного доступа к настройкам

**Технологии**: pydantic-settings

### 6. 🔧 Core Layer (src/core/)

**Назначение**: Базовая функциональность системы.

**Компоненты**:
- `logger.py` - продвинутое логирование с ротацией
- `exceptions.py` - кастомные исключения

**Уровни логирования**:
- DEBUG - детальная отладка
- INFO - основные события
- WARNING - предупреждения
- ERROR - ошибки без остановки
- CRITICAL - критические сбои

## 🔐 Безопасность

### Управление секретами
- Все токены и ключи хранятся в `.env`
- `.env` исключен из git
- Валидация наличия обязательных секретов при старте

### Обработка ошибок
- Graceful degradation - система продолжает работать при частичных сбоях
- Информативные сообщения пользователю без технических деталей
- Детальное логирование для разработчиков

### Модерация контента
- Отслеживание отклонений от темы
- Счетчик попыток нецелевого общения
- Автоматическое завершение диалога при систематических нарушениях

## 📊 Управление состояниями (FSM)

### Состояния диалога

1. **INITIAL** - начальное состояние
   - Приветствие пользователя
   - Объяснение функционала

2. **COLLECTING_NICHE** - сбор информации о нише
   - Запрос ниши
   - Валидация и сохранение

3. **COLLECTING_GOAL** - сбор информации о цели
   - Запрос цели контента
   - Валидация и сохранение

4. **COLLECTING_FORMAT** - сбор информации о формате
   - Запрос формата
   - Валидация и сохранение

5. **GENERATING_IDEAS** - генерация идей
   - Построение промпта
   - Вызов AI API
   - Парсинг JSON ответа
   - Отображение идей с кнопками

6. **WAITING_IDEA_CHOICE** - ожидание выбора идеи
   - Обработка выбора пользователя
   - Сохранение выбранной идеи

7. **GENERATING_POST** - генерация поста
   - Генерация текста поста
   - Создание промпта для изображения
   - Генерация изображения
   - Отправка результата

8. **COMPLETED** - завершение
   - Предложение создать новый пост
   - Возврат в начало или выход

### Переходы между состояниями

```
INITIAL 
   ↓
COLLECTING_NICHE 
   ↓
COLLECTING_GOAL 
   ↓
COLLECTING_FORMAT 
   ↓
GENERATING_IDEAS 
   ↓
WAITING_IDEA_CHOICE 
   ↓
GENERATING_POST 
   ↓
COMPLETED 
   ↓ (опционально)
INITIAL (новая сессия)
```

## 🚀 Масштабируемость

### Горизонтальное масштабирование
- Поддержка нескольких инстансов бота через webhook режим
- Использование Redis для хранения состояний FSM (опционально)

### Вертикальное масштабирование
- Асинхронная архитектура позволяет обрабатывать множество запросов одновременно
- Эффективное использование ресурсов через connection pooling

## 📈 Мониторинг и отладка

### Логирование
- Ротация логов по размеру
- Несколько уровней детализации
- Структурированные логи для анализа

### Метрики (для будущего расширения)
- Количество пользователей
- Время генерации постов
- Успешность запросов к API
- Популярные ниши и форматы

## 🔄 Обновление и развертывание

### Процесс обновления
1. Остановка бота
2. Обновление кода
3. Миграция данных (при необходимости)
4. Запуск новой версии

### Требования к окружению
- Python 3.10+
- Виртуальное окружение
- Переменные окружения в .env
- Доступ к интернету для API запросов

## 🎓 Принятые решения

### Почему aiogram 3.x?
- Современный асинхронный фреймворк
- Встроенная поддержка FSM
- Активное сообщество и обновления
- Типизация через pydantic

### Почему ProxyAPI.ru?
- Доступ к OpenAI из России без VPN
- OpenAI-совместимый API
- Надежность и стабильность
- Оплата в рублях

### Почему JSON для промптов?
- Структурированные ответы от AI
- Легкость парсинга
- Валидация данных
- Предсказуемость результатов

### Почему модульная архитектура?
- Легкость тестирования
- Возможность замены компонентов
- Повторное использование кода
- Упрощение поддержки

## 🆕 Обновления версии 1.0.0

### Умные приветствия

Бот теперь узнает повторных пользователей через глобальное хранилище `user_sessions`:

```python
# src/bot/handlers/start.py
user_sessions = {
    user_id: {
        "last_interaction": datetime,
        "session_count": int
    }
}
```

**Три типа приветствий:**
1. **first_time** - Полное приветствие для новых пользователей
2. **after_break** - Краткое приветствие после 12+ часов
3. **continue** - Очень короткое приветствие (6 вариантов, рандомно)

### Грамматическая коррекция ввода

Добавлена функция `reformulate_user_input()` в `conversation.py`:
- Исправляет грамматические ошибки пользовательского ввода
- Сохраняет оригинал для AI генерации
- Отображает красиво отформатированную версию

Пример: "я хлеб пеку" → "Выпечка хлеба"

### Адаптивная генерация изображений

- Новое состояние FSM: `ASKING_IMAGE`
- Функция `should_offer_image()` определяет нужность иллюстрации
- Вопрос об иллюстрации удаляется после выбора
- Грамматически правильные формулировки (падежи, предлоги)

### Retry механизмы и Fallback

**Отправка изображений:**
- 3 попытки с паузой 2 секунды
- Timeout 30 секунд для больших файлов
- Graceful degradation (текст без фото при сбое)

**Генерация текста:**
- Fallback GPT-5 → GPT-4o при:
  - Пустом контенте
  - Отказе модели (refusal)
  - `finish_reason: length`

### Динамическая адаптация API

Метод `chat_completion()` теперь динамически выбирает параметры:

```python
# max_tokens vs max_completion_tokens
if model in ["gpt-5", "o1", "o3"]:
    params["max_completion_tokens"] = max_tokens
else:
    params["max_tokens"] = max_tokens

# temperature (GPT-5/O1/O3 не поддерживают кастомную)
if model not in ["gpt-5", "o1", "o3"]:
    params["temperature"] = temperature
```

### Креативные промпты

Промпт для генерации постов полностью переработан:
- **Запрет списков** в стиле "меню ресторана"
- **Запрет явных маркеров** ("Инсайт:", "Лайфхак:")
- **Максимум 1 разделитель** ━━━ на пост
- **Сторителлинг** вместо инструкций
- Пример живого поста в промпте

### Docker и развертывание

- Готовый Dockerfile (Python 3.11 + ffmpeg)
- docker-compose.yml с автоперезапуском
- Скрипт deploy.sh для управления
- Полная документация по развертыванию

---

**Версия документа**: 1.0.0  
**Дата обновления**: 28 октября 2025  
**Автор**: Development Team

